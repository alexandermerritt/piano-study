#! /usr/bin/env python3
import csv
import genanki
import os

# Configuration
CSV_FILE = "treble-notes.csv"
DECK_NAME = "Treble Clef Notes"
DECK_ID = 2059400110  # must be unique; change if you make multiple decks
MODEL_ID = 1607392319
OUTPUT_FILE = "treble_notes.apkg"

# Define the card model (Front=Image, Back=Text)
model = genanki.Model(
    MODEL_ID,
    'Image->Text Model',
    fields=[
        {'name': 'Back'},
        {'name': 'Front'},
    ],
    templates=[
        {
            'name': 'Card 1',
            'qfmt': '{{Back}}',
            'afmt': '{{Front}}',
        },
    ])

# Create deck
deck = genanki.Deck(DECK_ID, DECK_NAME)

# Track media files
media_files = []

# Read CSV and add notes
with open(CSV_FILE, newline='', encoding='utf-8') as f:
    reader = csv.reader(f)
    for row in reader:
        if len(row) < 2:
            continue  # skip malformed rows
        image_filename, back_text = row[0].strip(), row[1].strip()

        # Ensure image exists
        if os.path.exists(image_filename):
            media_files.append(image_filename)
        else:
            print(f"⚠️ Warning: {image_filename} not found")

        # Add note to deck
        back_html = f'<div style="text-align:center;"><img src="{image_filename}"></div>'
        front_html = f'<div style="font-size:36px; text-align:center;">"{back_text}"</div>'
        note = genanki.Note(
            model=model,
            fields=[front_html, back_html])
        deck.add_note(note)

# Package deck with media
package = genanki.Package(deck)
package.media_files = media_files
package.write_to_file(OUTPUT_FILE)

print(f"✅ Created {OUTPUT_FILE} with {len(media_files)} media files")

